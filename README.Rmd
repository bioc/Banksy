---
output: 
    github_document:
        toc: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```
# Banksy

<!-- badges: start -->
<!-- badges: end -->

Banksy is an R packaged that incorporates spatial information to cluster cells 
in a feature space (e.g. gene expression). Spatial information is incorporated 
by averaging the features of the k nearest neighbours to generate new 
'neighbour' features for a given cell. This is concatenated to the cell's own 
features to generate a combined feature matrix which is used for constructing a 
nearest neighbour network. Leiden clustering is used to obtain spatially-informed
clusters.

## Installation

```{r, eval=F}
remotes::install_github("jleechung/Banksy")
```

Load the package:
```{r}
library(Banksy)
```

## Quick Start

### Input data

Inputs consist of an expression matrix and cell locations. Sample data provided with the package:
```{r}
expr <- readRDS(system.file('/extdata/expression.rds', package = 'Banksy'))
locs <- readRDS(system.file('/extdata/locations.rds', package = 'Banksy'))
```

The gene expression matrix for cells should either be a `data.frame` or sparse matrix of class `dgCMatrix`:
```{r}
head(expr[,1:5])
```

The locations of each cell as a `data.frame`:
```{r}
head(locs)
```

### Spatial clustering

First, create a *BanksyObject* with the expression matrix and cell locations.
```{r}
bank <- BanksyObject(own.expr = expr,
                     cell.locs = locs)
```

Compute the neighbour matrix, and scale and normalize matrix. The options below are defaults and listed for clarity.
```{r}
bank <- ComputeBanksy(bank,
                      normalizeColumns = TRUE,
                      normalizeColumnsTo = 100,
                      zScaleRows = TRUE,
                      zScaleBeforeAveraging = FALSE,
                      zScaleOwnAfterAveraging = TRUE,
                      zScaleNbrAfterAveraging = TRUE)
```

Obtain clusters for selected parameters.

- `lambda` $\in[0,1]$. A mixing parameter which determines how much spatial information is incorporated.  
- `resolution`. Leiden clustering resolution.  
- `kneighbours`. Number of k neighbours to use for constructing sNN.
```{r}
bank <- ClusterBanksy(bank, lambda = 0.25,
                            resolution = 1.2,
                            kneighbours = 30)
```

### Visualization

UMAP visualization:
```{r}
plotUMAP(bank, params = 'res1.2_lam0.25_k30', size = 0.02)
```

Spatial plot:
```{r}
plotSpatialDims(bank, params = 'res1.2_lam0.25_k30', size = 0.02)
```

## Session information
```{r}
sessionInfo()
```

