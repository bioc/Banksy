---
title: "Working with *BanksyObject*"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{banksy-object}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This article describes the *BanksyObject* class in detail and how to interact 
with it. 

## Class structure

An object of the *BanksyObject* class can be constructed as follows:

```{r setup}
library(Banksy)
bank <- BanksyObject()
```

*BanksyObject* has the following slots:
```{r slotnm}
slotNames(bank)
```

- `own.expr` stores the raw gene-cell expression matrix  
- `nbr.expr` stores the neighbour feature-cell expression matrix   
- `own.norm.scaled.expr` stores the normalized / scaled gene-cell expression 
   matrix  
- `nbr.norm.scaled.expr` stores the normalized / scaled neighbour feature-cell 
   expression matrix  
- `custom.expr` is an auxillary slot for storing a custom expression matrix
- `cell.locs` stores the cell locations   
- `meta.data` stores cell metadata, such as cluster labels or colours for 
   visualisation  
- `dim.reduction` stores dimension reductions 

Getter and setter methods are defined for each of these slots.
To illustrate these functionalities, we use the data attached with the package.
```{r rdata}
expr <- readRDS(system.file('/extdata/expression.rds', package = 'Banksy'))
locs <- readRDS(system.file('/extdata/locations.rds', package = 'Banksy'))
```

The *BanksyObject* can be constructed by supplying the gene-cell expression 
matrix and cell locations. 
```{r construct}
bank <- BanksyObject(own.expr = expr,
                     cell.locs = locs)

bank
```
The dataset consists of 6725 cells, 140 genes, with 2 spatial dimensions.

Calling *ComputeBanksy* computes the neighbour feature-cell expression matrix, 
and the normalized / scaled matrices (if applicable). 
```{r compute}
bank <- ComputeBanksy(bank)
head(bank)
```

This function populates the `nbr.expr`, `own.norm.scaled.expr` and 
`nbr.norm.scaled.expr` slots with their corresponding matrices.

We compute cluster information based on the gene-cell and neighbour feature-cell 
matrix.
```{r cluster}
bank <- ClusterBanksy(bank)
```

## Subsetting

*SubsetBanksy* allows users to subset a *BanksyObject* by dimension, genes, 
cells, and metadata columns. The *BanksyObject* can be subset by dimensions with
logical unquoted conditions. The variables here (e.g. `sdimx`) must correspond
to the columns names of the `cell.locs(bank)`. 
```{r subset1}
bankSubsetDim <- SubsetBanksy(bank,
                              dimx = sdimx > 1000 & sdimx < 4000,
                              dimy = sdimy > 2000 & sdimy < 3000)
head(bankSubsetDim)
```

The object can also be subset by cells with logical unquoted conditions:
```{r subset2}
bankSubsetCells <- SubsetBanksy(bank,
                                cells = c(cell_364, cell_367, cell_384, cell_389))
```

Similarly, the object can also be subset by any metadata column with logical 
unquoted conditions. Here, we select cells in clusters 4 to 6 based on the 
clustering with `res=1.2`, `lam=0.5`, `k=30`. 
```{r subset3}
bankSubsetMeta <- SubsetBanksy(bank,
                               metadata = res1.2_lam0.5_k30 %in% 4:6)
```

Subsetting by genes can be achieved by supplying a character vector of genes
to the `features` argument.
```{r subset4}
set.seed(42)
genes <- sample(rownames(own.expr(bank)), 10)
bankSubsetFeatures <- SubsetBanksy(bank,
                                   features = genes)
```

If multiple subsetting features are supplied, the intersection of all conditions
will be returned.

## Session information
```{r}
sessionInfo()
```

