---
title: "Finding optimal clustering parameters"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Finding optimal clustering parameters}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this article describes finding optimal clustering parameters. The 
*ClusterBanksy* function performs a grid search of parameters `lambda`, 
`resolution`, and `kneighbours`. 

## Parameters

`kneighbours` is the number of k neighbours used to construct the shared Nearest
Neighbour (sNN) network. `resolution` is the resolution used in Leiden clustering.
Higher resolutions yield more clusters.

The `lambda` parameter is a mixing parameter $\in[0,1]$ which determines how 
much spatial information is incorporated for clustering. Larger values 
incorporate more spatial information. 

Details:
Let the gene-cell matrix be $G_O$ and the neighbour feature-cell matrix be $G_N$.
The joint matrix used for clustering is the (row) concatenation of 
$\sqrt{1-\lambda}\;G_O$ and $\sqrt{\lambda}\;G_N$.

We demonstrate how a grid search of the parameter space can be performed.
```{r setup, eval=F}
library(Banksy)
expr <- readRDS(system.file('/extdata/expression.rds', package = 'Banksy'))
locs <- readRDS(system.file('/extdata/locations.rds', package = 'Banksy'))
bank <- BanksyObject(own.expr = expr,
                     cell.locs = locs)
bank <- ComputeBanksy(bank)
```

## Grid search

Define a parameter space. We explore different combinations of `lambda` and 
`resolution`, fixing `kneighbours`.
```{r params, eval=F}
lambda <- seq(0, 0.75, by = 0.25)
resolution <- seq(0.8, 1.2, by = 0.2)
kneighbours <- 30

bank <- ClusterBanksy(bank, 
                           lambda = lambda,
                           resolution = resolution,
                           kneighbours = kneighbours)
```

This populates the `meta.data` slot of the *BanksyObject* with cluster labels
for each combination of parameters.
```{r mdata, eval=F}
head(meta.data(bank)[,1:5])
```

## Connecting clusters

To compare between clusters obtained with different combination of parameters 
(a parameter run), the *Banksy* package implements *ConnectClusters* which
performs a mapping to harmonise cluster labels between different parameter runs.

```{r connect, eval=F}
bank <- ConnectClusters(bank)
```

This updates the `meta.data` slot with new cluster labels and colours that can
be used for visualisation. We can visualise connected output as follows.

First, obtain cluster names:
```{r clustnames, eval=F}
mdnames <- names(meta.data(bank))
clustnames <- mdnames[grep("^res.*lam0\\.", mdnames)]
clustnames
```

Generate UMAPs and Spatial Dimension plots for the above clusters:
```{r visual, fig.width=8, fig.height=8.5, fig.align='center', eval=F}
umaps <- lapply(clustnames, function(param) plotUMAP(bank, param, 
                                                     legend = FALSE, 
                                                     pt.size = 0.01, main.size = 3))
spatdims <- lapply(clustnames, function(param) plotSpatialDims(bank, param, 
                                                               pt.size = 0.01, main.size = 3))

#do.call("grid.arrange", c(umaps, ncol=3))
#do.call("grid.arrange", c(spatdims, ncol=3))
```
