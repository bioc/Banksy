---
title: "Finding optimal clustering parameters"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Finding optimal clustering parameters}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This article describes finding optimal clustering parameters. The 
*ClusterBanksy* function performs a grid search of parameters `lambda`, 
`resolution`, and `kneighbours`. 

## Parameters

`kneighbours` is the number of k neighbours used to construct the shared Nearest
Neighbour (sNN) network. `resolution` is the resolution used in Leiden clustering.
Higher resolutions yield more clusters.

The `lambda` parameter is a mixing parameter $\in[0,1]$ which determines how 
much spatial information is incorporated for clustering. Larger values 
incorporate more spatial information. Let the gene-cell matrix be $G_O$ and the 
neighbour feature-cell matrix be $G_N$. The joint matrix used for clustering is 
the (row) concatenation of $\sqrt{1-\lambda}\;G_O$ and $\sqrt{\lambda}\;G_N$.

We demonstrate how a grid search of the parameter space can be performed.
```{r setup, eval=T}
library(Banksy)
library(gridExtra)

expr <- as.matrix(readRDS(system.file('/extdata/expression.rds', package = 'Banksy')))
locs <- readRDS(system.file('/extdata/locations.rds', package = 'Banksy'))
bank <- BanksyObject(own.expr = expr,
                     cell.locs = locs)
bank <- NormalizeBanksy(bank)
bank <- ComputeBanksy(bank)
bank <- ScaleBanksy(bank)
```

## Grid search

Define a parameter space. We explore different combinations of `lambda` and 
`resolution`, fixing `kneighbours`.
```{r params, eval=T}
lambda <- c(0, 0.5)
resolution <- c(0.8, 1.2)
kneighbours <- 40

set.seed(1234)
bank <- ClusterBanksy(bank, 
                      lambda = lambda,
                      resolution = resolution,
                      kneighbours = kneighbours)
```

This populates the `meta.data` slot of the *BanksyObject* with cluster labels
for each combination of parameters.
```{r mdata, eval=T}
head(meta.data(bank)[,1:5])
```

## Connecting clusters

To compare between clusters obtained with different combination of parameters 
(a parameter run), the *Banksy* package implements *ConnectClusters* which
performs a mapping to harmonise cluster labels between different parameter runs.

```{r connect, eval=T}
bank <- ConnectClusters(bank)$BanksyObject
```

This updates the `meta.data` slot with new cluster labels and colours that can
be used for visualisation. We can visualise connected output as follows.

First, obtain cluster names:
```{r clustnames, eval=T}
mdnames <- names(meta.data(bank))
clustnames <- mdnames[grep('^res', mdnames)]
```

Generate UMAPs and Spatial Dimension plots for the above clusters. One can use 
the *grid.arrange* function from *gridExtra* to conveniently layout all plots 
for comparison:

```{r out, eval=T, fig.width=10, fig.height=8}
uplot <- Map(function(by, red) plotUMAP(bank, by = by, reduction = red, pt.size = 0.01),
             clustnames, rep(c('umap_0', 'umap_0.5'), each = 2))
do.call(grid.arrange, c(uplot, ncol = 2))

splot <- lapply(clustnames, function(by) plotSpatialDims(bank, by = by))
do.call(grid.arrange, c(splot, ncol = 2))
```
